<ocx-portal-page permission="BOOKMARK#VIEW" helpArticleId="PAGE_BOOKMARK_SEARCH" *ngrxLet="viewModel$ as vm">
  <ocx-page-header
    [header]="'BOOKMARK_SEARCH.HEADER' | translate"
    [subheader]="'BOOKMARK_SEARCH.SUB_HEADER' | translate"
    [actions]="pageActions"
  />

  <ocx-page-content>
    <p-message
      *ngIf="vm.loading"
      id="bm_search_message_loading"
      severity="info"
      styleClass="m-3 p-2"
      [text]="'ACTIONS.LOADING' | translate"
    ></p-message>
    <p-message
      *ngIf="vm.exceptionKey"
      id="bm_search_message_error"
      severity="error"
      styleClass="m-3 p-2"
      [text]="vm.exceptionKey! | translate"
    ></p-message>

    <p-table
      *ngIf="!(vm.loading || vm.exceptionKey)"
      #dataTable
      id="bm_search_table"
      styleClass="mx-3 mb-2"
      [value]="vm.results"
      [columns]="filteredColumns"
      dataKey="id"
      [globalFilterFields]="['displayName']"
      [reorderableColumns]="false"
      [scrollable]="true"
      scrollHeight="590px"
      [rows]="10"
      [rowsPerPageOptions]="[10, 30, 100]"
      [paginator]="true"
      [alwaysShowPaginator]="true"
      paginatorPosition="bottom"
      [showCurrentPageReport]="true"
      currentPageReportTemplate="{first} - {last} {{ 'ACTIONS.SEARCH.OF' | translate }} {totalRecords}"
    >
      <ng-template pTemplate="caption">
        <ocx-data-view-controls
          [supportedViews]="['table']"
          [enableFiltering]="true"
          [enableSorting]="false"
          [columnDefinitions]="bookmarkColumns"
          (columnsChange)="onColumnsChange($event)"
          (filterChange)="onFilterChange($event)"
          [translations]="dataViewControlsTranslations"
        ></ocx-data-view-controls>
      </ng-template>

      <ng-template pTemplate="emptymessage">
        <tr>
          <td id="bm_search_table_emptymessage" colspan="5">{{ 'ACTIONS.SEARCH.NO_DATA' | translate }}</td>
        </tr>
      </ng-template>

      <ng-template pTemplate="header" let-columns>
        <tr>
          <th pFrozenColumn id="bm_search_table_header_actions" class="border-right-1 text-center white-space-nowrap">
            {{ 'ACTIONS.LABEL' | translate }}
          </th>
          <th
            *ngFor="let col of columns"
            [id]="'bm_search_table_header_col_' + col.field"
            [class]="'white-space-nowrap ' + col.css"
            [pSortableColumn]="col.field"
            [attr.aria-label]="col.translationPrefix + '.' + col.header | translate"
            [pTooltip]="col.translationPrefix + '.TOOLTIPS.' + col.header | translate"
            tooltipPosition="top"
            tooltipEvent="hover"
          >
            {{ col.translationPrefix + '.' + col.header | translate }}
            <p-sortIcon *ngIf="col.sort" [field]="col.field"></p-sortIcon>
            <p-columnFilter *ngIf="col.hasFilter" type="text" [field]="col.field" display="menu"></p-columnFilter>
          </th>
        </tr>
      </ng-template>

      <ng-template pTemplate="body" let-i="rowIndex" let-rowData let-columns="columns">
        <tr [pSelectableRow]="vm.results">
          <!-- actions -->
          <td pFrozenColumn class="align-items-center border-right-1 text-center white-space-nowrap">
            <ng-container *ocxIfNotPermission="'BOOKMARK#EDIT'">
              <button
                pbutton
                type="button"
                *ocxIfPermission="'BOOKMARK#VIEW'"
                class="p-button-rounded font-medium p-button-text p-button p-component p-button-icon-only"
                [id]="'bm_search_table_row_' + i + '_action_view'"
                (click)="onDetail(rowData)"
                (keydown.enter)="onDetail(rowData)"
                (keydown.space)="onDetail(rowData)"
                [attr.aria-label]="'ACTIONS.VIEW.LABEL' | translate"
                [pTooltip]="'ACTIONS.VIEW.LABEL' | translate"
                tooltipPosition="top"
                tooltipEvent="hover"
              >
                <span class="font-medium p-button-icon pi pi-eye" aria-hidden="true"></span>
              </button>
            </ng-container>
            <button
              pbutton
              type="button"
              *ocxIfPermission="'BOOKMARK#EDIT'"
              [id]="'bm_search_table_row_' + i + '_action_edit'"
              class="p-button-rounded font-medium p-button-text p-button p-component p-button-icon-only"
              (click)="onDetail(rowData)"
              (keydown.enter)="onDetail(rowData)"
              (keydown.space)="onDetail(rowData)"
              [attr.aria-label]="'ACTIONS.EDIT.LABEL' | translate"
              [pTooltip]="'ACTIONS.EDIT.LABEL' | translate"
              tooltipPosition="top"
              tooltipEvent="hover"
            >
              <span class="font-medium p-button-icon pi pi-pencil" aria-hidden="true"></span>
            </button>
            <button
              pbutton
              type="button"
              *ocxIfPermission="'BOOKMARK#EDIT'"
              class="p-button-rounded font-medium p-button-text p-button p-component p-button-icon-only"
              [id]="'bm_search_table_row_' + i + '_action_copy'"
              (click)="onCopy(rowData)"
              (keydown.enter)="onCopy(rowData)"
              (keydown.space)="onCopy(rowData)"
              [attr.aria-label]="'ACTIONS.COPY.LABEL' | translate"
              [pTooltip]="'ACTIONS.COPY.LABEL' | translate"
              tooltipPosition="top"
              tooltipEvent="hover"
            >
              <span class="font-medium p-button-icon pi pi-copy" aria-hidden="true"></span>
            </button>
            <button
              pbutton
              type="button"
              *ocxIfPermission="'BOOKMARK#DELETE'"
              [id]="'bm_search_table_row_' + i + '_action_delete'"
              class="p-button-rounded font-medium p-button-text p-button p-component p-button-icon-only"
              (click)="onDelete(rowData)"
              (keydown.enter)="onDelete(rowData)"
              (keydown.space)="onDelete(rowData)"
              [attr.aria-label]="'ACTIONS.DELETE.LABEL' | translate"
              [pTooltip]="'ACTIONS.DELETE.LABEL' | translate"
              tooltipPosition="top"
              tooltipEvent="hover"
            >
              <span class="danger-action-text font-medium p-button-icon pi pi-trash" aria-hidden="true"></span>
            </button>
          </td>
          <td *ngFor="let col of columns" [id]="'bm_search_table_row_' + i + '_' + col.field" [class]="col.css">
            <!-- needs a div due to manage ellipsis -->
            <ng-container *ngIf="col.field === 'position'">{{ rowData[col.field] }}</ng-container>
            <div *ngIf="col.limit" class="text-ellipsis-2-lines">{{ rowData[col.field] }}</div>

            <ng-container *ngIf="col.field === 'url'">
              <div class="flex flex-row column-gap-2 align-items-center">
                <span
                  class="text-primary pi"
                  [ngClass]="rowData['url'] ? 'pi-globe' : 'pi-link'"
                  [attr.aria-label]="'BOOKMARK.TOOLTIPS.TYPE_' + (rowData['url'] ? 'URL' : 'PRODUCT') | translate"
                  [pTooltip]="'BOOKMARK.TOOLTIPS.TYPE_' + (rowData['url'] ? 'URL' : 'PRODUCT') | translate"
                  tooltipPosition="top"
                  tooltipEvent="hover"
                ></span>
                <!-- URL bookmark -->
                <div *ngIf="col.field === 'url' && rowData['url']" class="text-ellipsis-2-lines">
                  <a
                    [href]="rowData[col.field]"
                    target="_blank"
                    class="mt-1 p-1 border-round bookmark-link font-italic text-primary"
                  >
                    {{ limitText(rowData[col.field], 100) }}
                  </a>
                </div>
                <!-- OneCX product bookmark -->
                <div *ngIf="col.field === 'url' && !rowData['url']" class="text-ellipsis-2-lines">
                  <a
                    [routerLink]="getUrl(rowData) | async"
                    [queryParams]="rowData.query"
                    [fragment]="rowData.fragment"
                    class="mt-1 p-1 border-round bookmark-link font-italic text-primary"
                  >
                    {{ limitText(prepareUrlBookmarkLink(getUrl(rowData) | async, rowData), 100) }}
                  </a>
                </div>
              </div>
            </ng-container>
          </td>
        </tr>
      </ng-template>
    </p-table>
  </ocx-page-content>
</ocx-portal-page>
